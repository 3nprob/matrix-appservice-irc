Refactor Datastore code to be more generic.